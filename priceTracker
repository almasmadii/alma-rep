from bs4 import BeautifulSoup
import requests
import smtplib
import os
from dotenv import load_dotenv
url="https://www.amazon.com/Funko-Pop-TV-Stranger-Things/dp/B09LHXY1YJ/ref=sr_1_2?crid=2J1A8SGXE7A9H&dib=eyJ2IjoiMSJ9.TFVOabNyv8Zmij00jh7562VxTWcngQsqJj1m2NrGaUihXrcpQnd9f2tnZQOhla28viv4N0lJXxGRu9df2rsxZcHnE5v6WBfVt-M2fwvyPvc83mUfCfZlzi5NrgvOvT7SBmJd9J9Ki30QZIaNjiE18g.3IxMyWDzSkv3A1sbaQoKJso4ZumMEion47a6JXeG_po&dib_tag=se&keywords=max%2Bmayfield&qid=1767687174&s=toys-and-games&sprefix=max%2Bmay%2Ctoys-and-games%2C331&sr=1-2&th=1"
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "Accept-Language": "en-US,en;q=0.9"
}
load_dotenv()
response=requests.get(url,headers=headers)
website=response.content
soup=BeautifulSoup(website,"html.parser")
price=soup.find("span",class_="a-offscreen").get_text()
end_price=price.split("$")[1]
float_price=float(end_price)
title=soup.find(id="productTitle").get_text().strip()
target_price=40

smtp=smtplib.SMTP
if float_price<target_price:
    message=f"{title} is on sale for {price}!"

    with smtplib.SMTP(os.environ["SMTP_MAIL"],587) as connection:
        connection.starttls()
        result=connection.login(os.environ["MY_MAIL"],os.environ["EMAIL_PASSWORD"])
        connection.sendmail(from_addr=os.environ["MY_MAIL"],to_addrs=os.environ["MY_MAIL"],
        msg=f"Subject:Amazon Price Alert!\n\n{message}\n {url}".encode("utf-8")
        )
